<!-- Modal -->
<div
	id="default-modal"
	tabindex="-1"
	aria-hidden="true"
	class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"
>
	<div
		class="relative w-full max-w-4xl max-h-full bg-white rounded-lg shadow"
	>
		<!-- Close Button -->
		<button
			id="close-modal-btn"
			type="button"
			data-modal-hide="default-modal"
			class="absolute top-3 right-2.5 text-gray-400 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center"
		>
			<svg class="w-4 h-4" fill="none" viewBox="0 0 14 14">
				<path
					stroke="currentColor"
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M1 1l6 6m0 0l6 6M7 7l6-6M7 7L1 13"
				/>
			</svg>
		</button>

		<h2 class="text-xl font-bold px-6 pt-6 text-center">
			Tell me what you're researching on?
		</h2>

		<div class="p-6">
			<form id="research-form" class="max-w-xl mx-auto space-y-6">
				<!-- Topic -->
				<div>
					<label
						for="title"
						class="block mb-2 text-sm font-medium text-gray-900"
						>Your Topic</label
					>
					<textarea
						id="title"
						rows="3"
						class="w-full p-2.5 border border-gray-300 rounded-lg text-sm"
						placeholder="Gradient Descent Loss Value Prediction"
						required
					></textarea>
				</div>

				<!-- File Upload -->
				<div>
					<label
						for="dropzone-file"
						class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100"
					>
						<div
							class="flex flex-col items-center justify-center pt-5 pb-6"
						>
							<svg
								class="w-8 h-8 mb-4 text-gray-500"
								xmlns="http://www.w3.org/2000/svg"
								fill="none"
								viewBox="0 0 20 16"
							>
								<path
									stroke="currentColor"
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
								/>
							</svg>
							<p class="mb-2 text-sm text-gray-500">
								<span class="font-semibold"
									>Upload research papers</span
								>
								or drag & drop
							</p>
							<p class="text-xs text-gray-500">
								PDF only (10MB max)
							</p>
							<div
								id="selected-files"
								class="hidden mt-4 text-sm text-gray-700 bg-gray-200 p-2 rounded"
							>
								<p id="selected-files-text"></p>
							</div>
						</div>
						<input
							id="dropzone-file"
							type="file"
							class="hidden"
							multiple
							accept=".pdf"
						/>
					</label>
				</div>

				<!-- Loading Indicator -->
				<div
					id="uploading-status"
					class="hidden flex items-center justify-center text-blue-600 font-medium"
				>
					<svg
						class="animate-spin h-5 w-5 mr-2 text-blue-600"
						viewBox="0 0 24 24"
						fill="none"
					>
						<circle
							class="opacity-25"
							cx="12"
							cy="12"
							r="10"
							stroke="currentColor"
							stroke-width="4"
						></circle>
						<path
							class="opacity-75"
							fill="currentColor"
							d="M4 12a8 8 0 018-8v8z"
						></path>
					</svg>
					Uploading and generating research...
				</div>

				<!-- Success Message -->
				<div
					id="success-message"
					class="hidden text-green-600 text-center text-sm"
				>
					✅ Research processed successfully!
				</div>

				<!-- Error Message -->
				<div
					id="error-message"
					class="hidden text-red-600 text-center text-sm"
				></div>

				<!-- Submit Button -->
				<button
					type="submit"
					class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5"
				>
					Let's Start
				</button>
			</form>
		</div>
	</div>
</div>

<script>
	const form = document.getElementById("research-form");
	const modal = document.getElementById("default-modal");
	const closeModalBtn = document.getElementById("close-modal-btn");
	const uploadingStatus = document.getElementById("uploading-status");
	const successMessage = document.getElementById("success-message");
	const errorMessage = document.getElementById("error-message");
	const selectedFilesContainer = document.getElementById("selected-files");
	const selectedFilesText = document.getElementById("selected-files-text");

	document
		.getElementById("dropzone-file")
		.addEventListener("change", function () {
			const files = this.files;
			if (files.length > 0) {
				const fileNames = Array.from(files)
					.map((file) => file.name)
					.join(", ");
				selectedFilesText.textContent = `Selected PDFs: ${fileNames}`;
				selectedFilesContainer.classList.remove("hidden");
			} else {
				selectedFilesContainer.classList.add("hidden");
			}
		});

	closeModalBtn.addEventListener("click", () => {
		modal.classList.add("hidden");
	});

	form.addEventListener("submit", async (e) => {
		e.preventDefault();
		errorMessage.classList.add("hidden");
		successMessage.classList.add("hidden");

		const description = document.getElementById("title").value.trim();
		const files = document.getElementById("dropzone-file").files;

		if (!description || files.length === 0) {
			errorMessage.textContent =
				"❌ Please enter a topic and upload at least one PDF.";
			errorMessage.classList.remove("hidden");
			return;
		}

		const formData = new FormData();
		formData.append("description", description);
		formData.append("uuid", crypto.randomUUID());
		for (const file of files) {
			formData.append("files[]", file);
		}

		uploadingStatus.classList.remove("hidden");

		try {
			const res = await fetch("/generate_research_description", {
				method: "POST",
				body: formData,
			});

			const data = await res.json();
			uploadingStatus.classList.add("hidden");

			if (!res.ok || !data || !data.result) {
				errorMessage.textContent =
					"❌ " + (data.message || "Failed to process research.");
				errorMessage.classList.remove("hidden");
				return;
			}

			if (data.result === null || data.result === "") {
				errorMessage.textContent =
					"❌ No content generated from uploaded papers.";
				errorMessage.classList.remove("hidden");
				return;
			}

			successMessage.textContent = "✅ Research processed successfully!";
			successMessage.classList.remove("hidden");
			const newResult = {
				title: description || "Untitled Paper",
				timestamp: new Date().toISOString(),
			};

			let researchHistory =
				JSON.parse(localStorage.getItem("researchResult")) || [];

			researchHistory.unshift(newResult);

			localStorage.setItem(
				"researchResult",
				JSON.stringify(researchHistory)
			);

			setTimeout(() => {
        const event = new CustomEvent("research-history-updated");
window.dispatchEvent(event);

        {% comment %} renderResearchHistory(); {% endcomment %}
				successMessage.classList.add("hidden");
				document.getElementById("close-modal-btn").click();

			}, 2000);
		} catch (err) {
			uploadingStatus.classList.add("hidden");
			errorMessage.textContent = "❌ An error occurred while uploading.";
			errorMessage.classList.remove("hidden");
		}
	});
</script>
